@prefix ocqaRule: <https://w3id.org/ocqaRule#>.
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xml: <http://www.w3.org/XML/1998/namespace> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix ocqa: <https://w3id.org/ocqa#> .
@prefix obpa: <https://w3id.org/obpa#> .
@prefix ocqa: <https://w3id.org/ocqa#> .
@prefix dct: <http://purl.org/dc/terms/> .
@prefix dica: <https://w3id.org/digitalconstruction/0.5/Agents#> .
@prefix dice: <https://w3id.org/digitalconstruction/0.5/Entities#> .
@prefix dicp: <https://w3id.org/digitalconstruction/0.5/Processes#> .
@prefix ex: <https://example.org/ocqa/example#> .
@prefix props:    <http://lbd.arch.rwth-aachen.de/props#> .
@prefix beo:      <https://pi.pauwel.be/voc/buildingelement#> .
@prefix ocqa-screed:      <https://w3id.org/ocqa-screed#> .
@base <https://w3id.org/ocqaRule#>.
#Exchange hasInspectionObject to hasObject
# SHACL NodeShape for all dice:Foundation instances
ocqaRule:FoundationInspectionShape
    a sh:NodeShape ;
    sh:targetClass beo:Slab;
    sh:rule ocqaRule:PlanScreedFlatnessInspectionShape ;
    sh:rule ocqaRule:AssignFlatnessCharacteristic;
    sh:rule ocqaRule:AssignProcedureAndEquipment ;
    sh:rule ocqaRule:AssignTimeFrame 

.
ocqaRule:ScreedInspectionConditionShape
  a sh:NodeShape ;
  sh:property [
    sh:path props:gewerk_simple ;
    sh:hasValue "Betonarbeiten" ;
  ] ;
  sh:property [
    sh:path [ sh:inversePath dicp:hasObject ] ;
    sh:qualifiedValueShape [ sh:class ocqa-screed:FlatnessInspection ] ;
    sh:qualifiedMaxCount 0 ;
   ] ;
    sh:property [
     sh:path [ sh:inversePath dicp:hasObject ] ;
     sh:qualifiedValueShape [ sh:class ocqa-screed:Screeding ] ;
     sh:qualifiedMinCount 1 ;
  ] ;
    sh:property [
     sh:path [ sh:inversePath dicp:hasObject ] ;
     sh:qualifiedValueShape [ sh:class ocqa-screed:DryingScreed ] ;
     sh:qualifiedMinCount 1 ;
  ] .

ocqaRule:PlanScreedFlatnessInspectionShape
  a sh:SPARQLRule ;
  sh:order 0 ;
  sh:condition ocqaRule:ScreedInspectionConditionShape;
  sh:construct """
    PREFIX dicp: <https://w3id.org/digitalconstruction/0.5/Processes#>
    PREFIX ocqa: <https://w3id.org/ocqa#>
    PREFIX ocqa-screed:      <https://w3id.org/ocqa-screed#> 

    CONSTRUCT {
      ?ins a ocqa:Inspection,
         ocqa-screed:FlatnessInspection;
           ocqa:hasInspectionObject $this.
        ?activity dicp:precedes ?ins.
    }
    WHERE {
      # all screeding activities for this slab
      ?activity a ocqa-screed:Screeding ;
         dicp:hasObject $this .
      BIND( IRI(CONCAT("https://example.org/ocqa/example#Inspection_", STRUUID())) AS ?ins )
    }
  """ .

ocqaRule:AssignFlatnessCharacteristic
  a sh:SPARQLRule ;
  sh:order 1 ;
  # attached via sh:rule to your slab NodeShape; no sh:target* here
  sh:construct """
    PREFIX ocqa: <https://w3id.org/ocqa#>
    PREFIX ocqa-screed: <https://w3id.org/ocqa-screed#>

    CONSTRUCT {
      ?ins ocqa:hasInspCharacteristic ?blank.
    $this ocqa-screed:hasFlatness ?blank. 
      ?blank a ocqa-screed:Characteristic ;
 ocqa:hasAssignedCharacteristicValue ocqa-screed:AssignedFlatnessForScreed.

    }
    WHERE {
      $this ^ocqa:hasInspectionObject ?ins .
      ?ins a ocqa-screed:FlatnessInspection .
      BIND( BNODE() AS ?blank )
    }
  """ .

ocqaRule:AssignProcedureAndEquipment
  a sh:SPARQLRule ;
  sh:order 2 ;
  sh:construct """
    PREFIX ocqa: <https://w3id.org/ocqa#>
    PREFIX ocqa-screed: <https://w3id.org/ocqa-screed#>
    CONSTRUCT {
      ?ins ocqa:hasInspectionProcedure ocqa-screed:SpiritLevelMeasurement .
        ?ins ocqa:hasInspectionEquipment ocqa-screed:SpiritLevel, ocqa-screed:WedgeGauge.
    }
    WHERE {
      $this ^ocqa:hasInspectionObject ?ins .
      ?ins a ocqa-screed:FlatnessInspection .
    }
  """ .

ocqaRule:AssignTimeFrame
  a sh:SPARQLRule ;
  sh:order 3 ;
    sh:condition [
    sh:property [    # No timeframe already exist for inspection on this slab
        sh:path ([ sh:inversePath ocqa:hasInspectionObject ] dicp:occupiesTimeInterval ) ;
        sh:qualifiedValueShape [ sh:class ocqa-screed:Screeding ] ;
        sh:maxCount 0
    ]
    ];
  sh:construct """
    PREFIX ocqa: <https://w3id.org/ocqa#>
    PREFIX ocqa-screed: <https://w3id.org/ocqa-screed#>
    PREFIX dicp: <https://w3id.org/digitalconstruction/0.5/Processes#>
    PREFIX dice: <https://w3id.org/digitalconstruction/0.5/Entities#>
    PREFIX time: <http://www.w3.org/2006/time#>
    PREFIX xsd:  <http://www.w3.org/2001/XMLSchema#>
    CONSTRUCT {
      ?ins dicp:occupiesTimeInterval [
        dice:hasStart [ time:inXSDDateTime ?start ] ;
        dice:hasEnd   [ time:inXSDDateTime ?end   ]
      ] .
    }
    WHERE {
      $this ^ocqa:hasInspectionObject ?ins .
      ?ins a ocqa-screed:FlatnessInspection .
      ?scr a ocqa-screed:Screeding ; dicp:hasObject $this ;
           dicp:occupiesTimeInterval/dice:hasEnd/time:inXSDDateTime ?endOfScreeding .
    ?drying a ocqa-screed:DryingScreed ; dicp:hasObject $this ;
            dicp:occupiesTimeInterval/dice:hasEnd/time:inXSDDateTime ?endOfScreedDrying .
      BIND( (?endOfScreeding + "P7D"^^xsd:dayTimeDuration) AS ?start )
      BIND( ?endOfScreedDrying AS ?end )
    }
  """ .

